<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Product - Clothing & Measurements Dashboard</title>
    <link href="./dist/output.css" rel="stylesheet">
    <script src="./database/client.js"></script>
</head>

<body class="bg-gray-50 font-sans antialiased">
    <div class="min-h-screen py-8">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Header -->
            <div class="mb-8">
                <div class="flex items-center space-x-4 mb-4">
                    <button onclick="goBack()"
                        class="flex items-center text-gray-600 hover:text-gray-900 transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        Back to Dashboard
                    </button>
                </div>
                <h1 class="text-3xl font-bold text-gray-900">Add New Product</h1>
                <p class="text-gray-600 mt-2">Fill out the form below to add a new product to your inventory.</p>
            </div>

            <!-- Form Container -->
            <div class="bg-white rounded-xl shadow-sm">
                <form id="addProductForm" class="p-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Product Name -->
                        <div class="md:col-span-2">
                            <label for="productName" class="block text-sm font-medium text-gray-700 mb-2">
                                Product Name *
                            </label>
                            <input type="text" id="productName" name="productName" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Enter product name">
                            <p class="text-red-500 text-sm mt-1 hidden" id="productNameError">Product name is required
                            </p>
                        </div>

                        <!-- Category -->
                        <div>
                            <label for="category" class="block text-sm font-medium text-gray-700 mb-2">
                                Category *
                            </label>
                            <select id="category" name="category" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Select a category</option>
                                <option value="shirts">Shirts</option>
                                <option value="pants">Pants</option>
                                <option value="jackets">Jackets</option>
                                <option value="accessories">Accessories</option>
                                <option value="shoes">Shoes</option>
                                <option value="other">Other</option>
                            </select>
                            <p class="text-red-500 text-sm mt-1 hidden" id="categoryError">Category is required</p>
                        </div>

                        <!-- Size -->
                        <div>
                            <label for="size" class="block text-sm font-medium text-gray-700 mb-2">
                                Size *
                            </label>
                            <select id="size" name="size" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Select a size</option>
                                <option value="XS">XS</option>
                                <option value="S">S</option>
                                <option value="M">M</option>
                                <option value="L">L</option>
                                <option value="XL">XL</option>
                                <option value="XXL">XXL</option>
                                <option value="XXXL">XXXL</option>
                                <option value="One Size">One Size</option>
                            </select>
                            <p class="text-red-500 text-sm mt-1 hidden" id="sizeError">Size is required</p>
                        </div>

                        <!-- Price -->
                        <div>
                            <label for="price" class="block text-sm font-medium text-gray-700 mb-2">
                                Price ($) *
                            </label>
                            <input type="number" id="price" name="price" required step="0.01" min="0"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="0.00">
                            <p class="text-red-500 text-sm mt-1 hidden" id="priceError">Valid price is required</p>
                        </div>

                        <!-- Stock Quantity -->
                        <div>
                            <label for="stockQuantity" class="block text-sm font-medium text-gray-700 mb-2">
                                Stock Quantity *
                            </label>
                            <input type="number" id="stockQuantity" name="stockQuantity" required min="0"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="0">
                            <p class="text-red-500 text-sm mt-1 hidden" id="stockQuantityError">Stock quantity is
                                required</p>
                        </div>

                        <!-- Color -->
                        <div>
                            <label for="color" class="block text-sm font-medium text-gray-700 mb-2">
                                Color
                            </label>
                            <input type="text" id="color" name="color"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Enter product color">
                        </div>

                        <!-- Brand -->
                        <div>
                            <label for="brand" class="block text-sm font-medium text-gray-700 mb-2">
                                Brand
                            </label>
                            <input type="text" id="brand" name="brand"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Enter brand name">
                        </div>

                        <!-- Description -->
                        <div class="md:col-span-2">
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                                Description
                            </label>
                            <textarea id="description" name="description" rows="4"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                placeholder="Enter product description, features, care instructions, etc."></textarea>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex flex-col sm:flex-row gap-4 mt-8 pt-6 border-t border-gray-200">
                        <button type="button" onclick="goBack()"
                            class="flex-1 sm:flex-none px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancel
                        </button>
                        <button type="submit"
                            class="flex-1 sm:flex-none px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <span id="submitText">Add Product</span>
                            <span id="submitLoading" class="hidden">
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline"
                                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                                Adding...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="messageContainer" class="fixed top-4 right-4 z-50"></div>

    <script>
        // Form validation and submission
        document.getElementById('addProductForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            if (!validateForm()) {
                return;
            }

            const submitButton = e.target.querySelector('button[type="submit"]');
            const submitText = document.getElementById('submitText');
            const submitLoading = document.getElementById('submitLoading');

            // Show loading state
            submitButton.disabled = true;
            submitText.classList.add('hidden');
            submitLoading.classList.remove('hidden');

            try {
                const formData = new FormData(e.target);

                // Create product data object that matches the database schema
                const productData = {
                    name: formData.get('productName'),
                    description: formData.get('description') || null,
                    category_id: getCategoryId(formData.get('category')),
                    price: parseFloat(formData.get('price')),
                    stock_quantity: parseInt(formData.get('stockQuantity')),
                    image_url: null // We're not handling images yet
                };

                console.log('Creating product with data:', productData); // Debug log

                // Add product to database
                await window.db.createProduct(productData);

                showMessage('Product added successfully!', 'success');

                // Reset form after successful submission
                e.target.reset();

                // Redirect back to dashboard after a short delay
                setTimeout(() => {
                    goBack();
                }, 1500);

            } catch (error) {
                console.error('Error adding product:', error);
                showMessage('Error adding product. Please try again.', 'error');
            } finally {
                // Reset button state
                submitButton.disabled = false;
                submitText.classList.remove('hidden');
                submitLoading.classList.add('hidden');
            }
        });

        function validateForm() {
            let isValid = true;
            const requiredFields = [
                { id: 'productName', errorId: 'productNameError', message: 'Product name is required' },
                { id: 'category', errorId: 'categoryError', message: 'Category is required' },
                { id: 'price', errorId: 'priceError', message: 'Valid price is required' },
                { id: 'stockQuantity', errorId: 'stockQuantityError', message: 'Stock quantity is required' }
            ];

            // Reset all error messages
            requiredFields.forEach(field => {
                document.getElementById(field.errorId).classList.add('hidden');
                document.getElementById(field.id).classList.remove('border-red-500');
            });

            // Validate each required field
            requiredFields.forEach(field => {
                const element = document.getElementById(field.id);
                const value = element.value.trim();

                if (!value || (field.id === 'price' && parseFloat(value) <= 0) ||
                    (field.id === 'stockQuantity' && parseInt(value) < 0)) {
                    isValid = false;
                    element.classList.add('border-red-500');
                    document.getElementById(field.errorId).classList.remove('hidden');
                }
            });

            return isValid;
        }

        // Helper function to get category ID from category name
        function getCategoryId(categoryName) {
            if (!categoryName) return null;

            // Simple mapping for category names to IDs
            const categoryMap = {
                'shirts': 1,
                'pants': 2,
                'dresses': 3,
                'jackets': 4,
                'accessories': 5,
                'shoes': 6,
                'underwear': 7,
                'other': 8
            };

            return categoryMap[categoryName.toLowerCase()] || 8; // Default to 'other'
        }

        function goBack() {
            window.location.href = 'page2.html';
        }

        function showMessage(message, type) {
            const messageContainer = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');

            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';

            messageDiv.innerHTML = `
                <div class="${bgColor} text-white px-6 py-4 rounded-lg shadow-lg mb-4 max-w-sm">
                    <div class="flex items-center">
                        <span class="mr-2">
                            ${type === 'success' ?
                    '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>' :
                    '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>'
                }
                        </span>
                        <span>${message}</span>
                    </div>
                </div>
            `;

            messageContainer.appendChild(messageDiv);

            // Auto-remove message after 3 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Auto-generate SKU based on product name and category
        document.getElementById('productName').addEventListener('input', generateSKU);
        document.getElementById('category').addEventListener('change', generateSKU);

        function generateSKU() {
            const productName = document.getElementById('productName').value.trim();
            const category = document.getElementById('category').value;
            const skuField = document.getElementById('sku');

            if (productName && category && !skuField.value) {
                const namePrefix = productName.substring(0, 3).toUpperCase();
                const categoryPrefix = category.substring(0, 3).toUpperCase();
                const randomNumber = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                skuField.value = `${categoryPrefix}-${namePrefix}-${randomNumber}`;
            }
        }
    </script>
</body>

</html>